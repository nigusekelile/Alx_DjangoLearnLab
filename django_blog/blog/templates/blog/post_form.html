{% extends 'blog/base.html' %}

{% block title %}{{ title|default:"Create Post" }} - Django Blog{% endblock %}

{% block content %}
<div class="post-form-container">
    <div class="post-form-header">
        <h1>{{ title|default:"Create New Post" }}</h1>
        <p>Share your thoughts and ideas with the world</p>
    </div>
    
    <div class="post-form-wrapper">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="{{ form.title.id_for_label }}">Title:</label>
                {{ form.title }}
                {% if form.title.errors %}
                <div class="error-message">
                    {% for error in form.title.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
                {% endif %}
                <small class="form-text text-muted">Choose a descriptive title for your post (minimum 5 characters).</small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.tags_input.id_for_label }}">Tags:</label>
                {{ form.tags_input }}
                {% if form.tags_input.errors %}
                <div class="error-message">
                    {% for error in form.tags_input.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
                {% endif %}
                <small class="form-text text-muted">{{ form.tags_input.help_text }}</small>
                <div id="tag-suggestions" class="tag-suggestions"></div>
                <div id="selected-tags" class="selected-tags"></div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.content.id_for_label }}">Content:</label>
                {{ form.content }}
                {% if form.content.errors %}
                <div class="error-message">
                    {% for error in form.content.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
                {% endif %}
                <small class="form-text text-muted">Write your post content here. You can use basic HTML tags.</small>
            </div>
            
            <div class="form-tips">
                <h4>Tips for a great blog post:</h4>
                <ul>
                    <li>Start with a compelling introduction</li>
                    <li>Use headings to organize your content</li>
                    <li>Break up long paragraphs for readability</li>
                    <li>Add relevant tags to help readers find your post</li>
                    <li>End with a conclusion or call to action</li>
                </ul>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-paper-plane"></i> {{ submit_text|default:"Publish Post" }}
                </button>
                <a href="{% if post %}{% url 'post-detail' post.pk %}{% else %}{% url 'post-list' %}{% endif %}" 
                   class="btn btn-lg">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.tag-suggestions {
    margin-top: 10px;
    display: none;
}

.tag-suggestions.active {
    display: block;
}

.tag-suggestion-list {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tag-suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.tag-suggestion-item:hover {
    background-color: #f5f5f5;
}

.selected-tags {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.selected-tag {
    background: #e8f4fc;
    color: #3498db;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.remove-tag {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
    line-height: 1;
}

.remove-tag:hover {
    color: #c0392b;
}
</style>

<script>
// Tag management functionality
document.addEventListener('DOMContentLoaded', function() {
    const tagsInput = document.getElementById('tags-input');
    const tagSuggestions = document.getElementById('tag-suggestions');
    const selectedTags = document.getElementById('selected-tags');
    
    let currentTags = [];
    
    // Parse existing tags from input
    function parseExistingTags() {
        const value = tagsInput.value;
        if (value) {
            return value.split(',').map(tag => tag.trim()).filter(tag => tag);
        }
        return [];
    }
    
    // Update selected tags display
    function updateSelectedTags() {
        selectedTags.innerHTML = '';
        currentTags.forEach((tag, index) => {
            const tagElement = document.createElement('div');
            tagElement.className = 'selected-tag';
            tagElement.innerHTML = `
                ${tag}
                <button type="button" class="remove-tag" data-index="${index}">
                    &times;
                </button>
            `;
            selectedTags.appendChild(tagElement);
        });
        
        // Add remove event listeners
        document.querySelectorAll('.remove-tag').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                currentTags.splice(index, 1);
                updateSelectedTags();
                updateTagsInput();
            });
        });
    }
    
    // Update the hidden input
    function updateTagsInput() {
        tagsInput.value = currentTags.join(', ');
    }
    
    // Initialize
    currentTags = parseExistingTags();
    updateSelectedTags();
    
    // Tag input event listener
    tagsInput.addEventListener('input', function() {
        const value = this.value;
        const lastChar = value[value.length - 1];
        
        // If comma is entered, add the tag
        if (lastChar === ',') {
            const tag = value.slice(0, -1).trim();
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                updateSelectedTags();
                this.value = '';
            }
        }
        
        // Show suggestions if typing
        const currentWord = value.split(',').pop().trim();
        if (currentWord.length > 1) {
            fetchTagSuggestions(currentWord);
        } else {
            hideSuggestions();
        }
        
        updateTagsInput();
    });
    
    // Fetch tag suggestions from server
    function fetchTagSuggestions(query) {
        fetch(`/tag-suggestions/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                showSuggestions(data.suggestions, query);
            })
            .catch(error => {
                console.error('Error fetching tag suggestions:', error);
            });
    }
    
    // Show suggestions
    function showSuggestions(suggestions, query) {
        if (suggestions.length === 0) return;
        
        tagSuggestions.innerHTML = '';
        tagSuggestions.className = 'tag-suggestions active';
        
        const suggestionList = document.createElement('div');
        suggestionList.className = 'tag-suggestion-list';
        
        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'tag-suggestion-item';
            item.textContent = suggestion.name;
            item.addEventListener('click', function() {
                if (!currentTags.includes(suggestion.name)) {
                    currentTags.push(suggestion.name);
                    updateSelectedTags();
                    updateTagsInput();
                }
                tagsInput.value = '';
                hideSuggestions();
            });
            suggestionList.appendChild(item);
        });
        
        // Add option to create new tag
        const newTagItem = document.createElement('div');
        newTagItem.className = 'tag-suggestion-item';
        newTagItem.innerHTML = `<em>Create new tag: "${query}"</em>`;
        newTagItem.addEventListener('click', function() {
            if (!currentTags.includes(query)) {
                currentTags.push(query);
                updateSelectedTags();
                updateTagsInput();
            }
            tagsInput.value = '';
            hideSuggestions();
        });
        suggestionList.appendChild(newTagItem);
        
        tagSuggestions.appendChild(suggestionList);
    }
    
    // Hide suggestions
    function hideSuggestions() {
        tagSuggestions.className = 'tag-suggestions';
        tagSuggestions.innerHTML = '';
    }
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(event) {
        if (!tagsInput.contains(event.target) && !tagSuggestions.contains(event.target)) {
            hideSuggestions();
        }
    });
});
</script>
{% endblock %}